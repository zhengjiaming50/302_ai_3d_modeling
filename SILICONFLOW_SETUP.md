# SiliconFlow 视觉AI标注功能配置指南

## 概述

阶段三实现了SiliconFlow视觉AI集成，用于自动分析和标注上传的图片。系统会在图片上传后自动调用SiliconFlow的视觉模型分析图片内容，生成个体特征描述并存储到数据库中。

## 功能特性

1. **自动图片分析**：上传图片后自动调用SiliconFlow视觉AI进行分析
2. **个体特征描述**：AI生成人物独特生理特征的自然描述
3. **简化存储**：每张图片对应一个完整的特征描述标签
4. **异步处理**：标注处理不阻塞图片上传流程
5. **错误容错**：AI标注失败不影响图片正常上传和使用

## 环境配置

### 1. 获取SiliconFlow API密钥

1. 访问 [SiliconFlow官网](https://cloud.siliconflow.cn)
2. 注册并登录账户
3. 进入控制台，获取API密钥

### 2. 配置环境变量

在项目根目录的 `.env.local` 文件中添加：

```env
# SiliconFlow API配置
SILICONFLOW_API_KEY=your_siliconflow_api_key_here
```

**注意**：请将 `your_siliconflow_api_key_here` 替换为您实际的API密钥。

### 3. 重启应用

配置完成后重启开发服务器：

```bash
npm run dev
```

## 使用的API模型

- **模型**：`Qwen/Qwen2-VL-72B-Instruct`
- **分析质量**：高质量（`detail: "high"`）
- **分析方式**：自然语言描述个体特征
- **分析重点**：
  - **面部特征**：脸型、眼部、鼻部、嘴部、额头、下巴等具体特征
  - **身材特征**：体型、身高比例、肩膀宽度等
  - **头发特征**：发色、发质、发型、发量等
  - **皮肤特征**：肤色、肤质、明显的痣或疤痕等
  - **年龄特征**：具体年龄段和衰老特征

## 分析策略

### 自然描述方式
- AI用自然语言描述人物特征，无需特定格式
- 整个描述作为一个标签存储到数据库
- 避免复杂的标签解析，简化存储逻辑

### 关注个体差异
- 专注于能够区分不同个体的独特特征
- 避免描述服装、场景、职业等外在因素
- 重点分析不可改变的生理特征

## API接口说明

### 1. 手动创建标注

```http
POST /api/ai-annotations
Content-Type: application/json

{
  "imageId": "图片ID",
  "imageUrl": "图片URL",
  "customPrompt": "自定义分析提示词（可选）"
}
```

### 2. 获取图片标注

```http
GET /api/ai-annotations?imageId=图片ID
```

## 工作流程

1. **图片上传**：用户上传图片到系统
2. **保存记录**：图片信息保存到数据库
3. **触发标注**：异步调用SiliconFlow API分析图片
4. **特征描述**：AI用自然语言描述人物独特的生理特征
5. **存储描述**：将完整的特征描述作为一个标签保存到数据库
6. **建立关联**：创建图片与特征描述的关联关系

## 数据库表结构

- **ai_tags**：存储AI生成的完整特征描述（每个图片一条记录）
- **ai_tag_images**：存储图片和特征描述的关联关系

## 标注示例

### 标注结果示例
```json
{
  "annotations": [
    {
      "tag": "这是一位中年男性，拥有方形脸型和深邃的眼窝。他的鼻梁高挺，嘴唇较薄，银白色的头发显示出明显的年龄特征。颧骨较为突出，眼角有明显的皱纹，整体面部轮廓棱角分明。",
      "description": "AI生成的个体特征描述：这是一位中年男性，拥有方形脸型和深邃的眼窝...",
      "confidence": 0.8,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### 数据存储特点
- **一图一描述**：每张图片对应一个完整的特征描述
- **自然语言**：描述采用自然语言表达，便于阅读理解
- **特征专注**：专注于个体生理特征，避免外在因素

## 错误处理

- API调用失败：记录错误日志，不影响图片上传
- 解析失败：使用默认特征描述，确保流程继续
- 网络超时：自动重试机制

## 注意事项

1. **API限制**：注意SiliconFlow的API调用频率限制
2. **成本控制**：视觉模型调用会产生费用，请合理使用
3. **网络要求**：需要稳定的网络连接访问SiliconFlow API
4. **异步处理**：标注是异步进行的，可能需要几秒钟完成
5. **描述准确性**：AI分析的个体特征描述仅供参考，可能存在误差
6. **存储空间**：由于是完整描述，单个标签占用存储空间较大

## 测试验证

1. 上传一张人物图片
2. 检查控制台日志是否显示标注开始和完成
3. 调用 `/api/ai-annotations?imageId=xxx` 查看标注结果
4. 验证返回的标签是完整的特征描述而非关键词列表
5. 检查数据库中是否正确保存了特征描述信息

## 故障排除

### API密钥配置问题

```
Error: SILICONFLOW_API_KEY not configured
```

**解决方案**：检查环境变量配置是否正确。

### API调用失败

```
SiliconFlow API error: 401 Unauthorized
```

**解决方案**：检查API密钥是否有效。

### 网络连接问题

```
Failed to analyze image: Network error
```

**解决方案**：检查网络连接是否正常。 