# 3D建模系统对比分析功能 - 接口文档

## 数据库模型接口

### 图片模型 (Image)

```typescript
interface Image {
  id: string;
  fileName: string;
  fileUrl: string;
  localFilePath?: string; // 本地存储路径
  mimeType: string;
  size?: number;
  createdAt: Date;
  updatedAt: Date;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `create` | 创建新图片记录 | `CreateImageData` | `Promise<Image>` |
| `findById` | 根据ID查找图片 | `id: string` | `Promise<Image \| null>` |
| `findAll` | 获取图片列表 | `limit?: number, offset?: number` | `Promise<Image[]>` |
| `update` | 更新图片信息 | `id: string, data: Partial<CreateImageData>` | `Promise<boolean>` |
| `delete` | 删除图片 | `id: string` | `Promise<boolean>` |

### 模型类 (Model)

```typescript
interface Model {
  id: string;
  fileName: string;
  fileUrl: string;
  localFilePath?: string; // 本地存储路径
  format?: string;
  size?: number;
  parameters?: string;
  createdAt: Date;
  updatedAt: Date;
  imageId: string;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `create` | 创建新3D模型记录 | `CreateModelData` | `Promise<Model>` |
| `findById` | 根据ID查找模型 | `id: string` | `Promise<Model \| null>` |
| `findByImageId` | 根据图片ID查找模型 | `imageId: string` | `Promise<Model \| null>` |
| `findAll` | 获取模型列表 | `limit?: number, offset?: number` | `Promise<Model[]>` |
| `update` | 更新模型信息 | `id: string, data: Partial<CreateModelData>` | `Promise<boolean>` |
| `delete` | 删除模型 | `id: string` | `Promise<boolean>` |

### AI标签 (AITag)

```typescript
interface AITag {
  id: string;
  name: string;
  description?: string;
  category?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `create` | 创建新标签 | `CreateAITagData` | `Promise<AITag>` |
| `findById` | 根据ID查找标签 | `id: string` | `Promise<AITag \| null>` |
| `findByName` | 根据名称查找标签 | `name: string` | `Promise<AITag \| null>` |
| `findOrCreate` | 查找或创建标签 | `CreateAITagData` | `Promise<AITag>` |
| `findAll` | 获取标签列表 | `limit?: number, offset?: number` | `Promise<AITag[]>` |
| `findByImageId` | 获取图片相关标签 | `imageId: string` | `Promise<AITag[]>` |
| `update` | 更新标签信息 | `id: string, data: Partial<CreateAITagData>` | `Promise<boolean>` |
| `delete` | 删除标签 | `id: string` | `Promise<boolean>` |

### 标签图片关联 (AITagImage)

```typescript
interface AITagImage {
  id: string;
  imageId: string;
  tagId: string;
  confidence?: number;
  createdAt: Date;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `create` | 创建标签-图片关联 | `CreateAITagImageData` | `Promise<AITagImage>` |
| `findByImageAndTag` | 查找特定关联 | `imageId: string, tagId: string` | `Promise<AITagImage \| null>` |
| `findByImageId` | 查找图片的所有标签关联 | `imageId: string` | `Promise<AITagImage[]>` |
| `findByTagId` | 查找标签的所有图片关联 | `tagId: string` | `Promise<AITagImage[]>` |
| `addTagToImage` | 给图片添加标签 | `imageId: string, tagId: string, confidence?: number` | `Promise<AITagImage>` |
| `removeTagFromImage` | 移除图片标签 | `imageId: string, tagId: string` | `Promise<boolean>` |
| `removeAllTagsFromImage` | 移除图片所有标签 | `imageId: string` | `Promise<boolean>` |

### 对比记录 (Comparison)

```typescript
interface Comparison {
  id: string;
  uploadedImageId: string;
  matchedModelId: string;
  similarityScore?: number;
  createdAt: Date;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `create` | 创建对比记录 | `CreateComparisonData` | `Promise<Comparison>` |
| `findById` | 根据ID查找对比记录 | `id: string` | `Promise<Comparison \| null>` |
| `findByUploadedImageId` | 查找上传图片的对比记录 | `uploadedImageId: string` | `Promise<Comparison[]>` |
| `findByMatchedModelId` | 查找匹配模型的对比记录 | `matchedModelId: string` | `Promise<Comparison[]>` |
| `findAll` | 获取所有对比记录 | `limit?: number, offset?: number` | `Promise<Comparison[]>` |
| `update` | 更新对比记录 | `id: string, data: Partial<CreateComparisonData>` | `Promise<boolean>` |
| `delete` | 删除对比记录 | `id: string` | `Promise<boolean>` |

## 视觉AI服务

### 视觉AI分析服务 (SiliconFlowVisionService)

```typescript
interface TagAnalysisResult {
  tags: string[];
  description: string;
}

class SiliconFlowVisionService {
  static async analyzeImage(imageUrl: string): Promise<TagAnalysisResult>;
  static async saveImageTagsToDatabase(imageId: string, imageUrl: string): Promise<string[]>;
}
```

#### 方法

| 方法 | 描述 | 参数 | 返回值 |
| --- | --- | --- | --- |
| `analyzeImage` | 分析图片内容并提取标签和描述 | `imageUrl: string` | `Promise<TagAnalysisResult>` |
| `saveImageTagsToDatabase` | 分析图片并将标签保存到数据库 | `imageId: string, imageUrl: string` | `Promise<string[]>` (标签ID列表) |

#### 功能

- 调用硅基流动视觉AI API进行图片内容分析
- 自动提取图片中的关键特征作为标签
- 生成图片描述性文本
- 将图片标签保存到数据库中并建立图片-标签关联
- 支持远程URL、本地文件路径和base64编码的图片
- 智能压缩大图片，确保不超过API大小限制

### 视觉AI请求接口

```typescript
interface VisionAIRequest {
  model: string;
  messages: {
    role: string;
    content: Array<{
      type: string;
      image_url?: {
        url: string;
        detail?: string;
      };
      text?: string;
    }>;
  }[];
  max_tokens?: number;
  stream?: boolean;
}
```

### 视觉AI响应接口

```typescript
interface VisionAIResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: {
    message: {
      role: string;
      content: string;
    };
    index: number;
    finish_reason: string;
  }[];
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}
```

## API端点

### 图片上传API

#### POST /api/images

图片上传API支持自动进行视觉AI标注，在图片成功保存后，会异步调用视觉AI服务分析图片内容并保存标签。

##### 请求体

```json
{
  "fileName": "image.png",
  "fileUrl": "https://example.com/image.png",
  "mimeType": "image/png",
  "size": 1024
}
```

##### 响应体

```json
{
  "id": "uuid-of-image",
  "localFilePath": "storage/images/image.png",
  "success": true
}
```

##### 处理流程

1. 接收图片信息
2. 保存远程图片到本地文件系统
3. 创建图片记录到数据库
4. 异步调用视觉AI服务进行图片标注
5. 保存标签到数据库并建立与图片的关联

### 图片分析API

#### POST /api/analyze-image

该API端点用于分析图片内容并提取标签信息，通常由图片上传API内部调用。

##### 请求体

```json
{
  "imageId": "uuid-of-image",
  "imageUrl": "https://example.com/image.png"
}
```

##### 响应体

```json
{
  "success": true,
  "message": "成功为图片添加10个标签",
  "tagIds": ["tag-id-1", "tag-id-2", "..."]
}
```

### 对比分析API

#### POST /api/comparison

该API端点用于执行图片相似度对比分析，上传新图片后与数据库中的历史图片比较，找出最相似的模型。

##### 请求体

```json
{
  "fileName": "comparison-image.png",
  "fileUrl": "https://example.com/comparison-image.png",
  "mimeType": "image/png",
  "size": 1024
}
```

##### 响应体

```json
{
  "success": true,
  "uploadedImage": {
    "id": "uuid-of-uploaded-image",
    "url": "https://example.com/comparison-image.png"
  },
  "matchedModel": {
    "id": "uuid-of-matched-model",
    "url": "https://example.com/model.glb",
    "fileName": "model.glb",
    "imageId": "uuid-of-history-image"
  },
  "similarityScore": 0.75,
  "commonTags": ["人像", "微笑", "男性"],
  "comparisonId": "uuid-of-comparison"
}
```

##### 处理流程

1. 保存上传的图片到数据库和本地文件系统
2. 使用视觉AI标注上传的图片
3. 获取数据库中所有历史图片和关联模型
4. 获取上传图片和历史图片的AI标签
5. 计算标签的Jaccard相似度
6. 找出相似度最高的图片及其关联模型
7. 创建对比记录并返回结果

##### 简化实现（临时）

由于时间限制，当前实现采用了简化方案：
1. 客户端模拟API请求，显示进度条动画
2. 根据使用次数轮流展示预设的两个GLB模型文件
3. 第一次请求显示：`1747823628103.glb`
4. 第二次请求显示：`1747824003261.glb`
5. 相似度固定为75%，使用固定的通用标签

#### GET /api/comparison

查询对比记录信息，支持按ID查询特定记录或获取所有记录列表。

##### 请求参数

- `id`: (可选) 对比记录ID
- `limit`: (可选) 结果数量限制，默认20
- `offset`: (可选) 分页偏移量，默认0

##### 响应体

查询单个记录:
```json
{
  "comparison": {
    "id": "uuid-of-comparison",
    "uploadedImageId": "uuid-of-uploaded-image",
    "matchedModelId": "uuid-of-matched-model",
    "similarityScore": 0.75,
    "createdAt": "2023-01-01T12:00:00Z"
  },
  "uploadedImage": {
    "id": "uuid-of-uploaded-image",
    "fileName": "uploaded.png",
    "fileUrl": "https://example.com/uploaded.png",
    "..." : "其他图片字段"
  },
  "matchedModel": {
    "id": "uuid-of-matched-model",
    "fileName": "model.glb",
    "fileUrl": "https://example.com/model.glb",
    "..." : "其他模型字段"
  }
}
```

查询列表:
```json
[
  {
    "id": "uuid-of-comparison-1",
    "uploadedImageId": "uuid-of-uploaded-image-1",
    "matchedModelId": "uuid-of-matched-model-1",
    "similarityScore": 0.75,
    "createdAt": "2023-01-01T12:00:00Z"
  },
  {
    "id": "uuid-of-comparison-2",
    "..." : "其他对比记录字段"
  }
]
```

## 数据库工具

### 查询函数

```typescript
function query<T = any>(sql: string, params: any[] = []): Promise<T>
```

### 事务函数

```typescript
function transaction<T>(callback: (connection: mysql.Connection) => Promise<T>): Promise<T>
```

### ID生成函数

```typescript
function generateId(): string
```

### 数据库初始化

```typescript
function initializeDatabase(): Promise<void>
```

## 数据库表结构

所有表包含必要的主键、外键和索引，关系如下：

1. **images**: 存储原始图片信息
2. **models**: 存储3D模型信息，与images是一对一关系
3. **ai_tags**: 存储AI标签信息
4. **ai_tag_images**: 存储图片和标签的多对多关系
5. **image_tags**: 存储用户自定义标签
6. **comparisons**: 存储图片比较结果

详细表结构参见 `sql/schema.sql` 文件。

## 组件接口

### 图片上传组件 (ImageUploader)

```typescript
interface ImageUploaderProps {
  onUpload: (imageUrl: string, imageId?: string) => void;
}
```

#### 功能

- 支持图片拖放上传
- 支持剪贴板粘贴上传
- 支持调用本地摄像头拍摄照片上传
- 自动转换为PNG格式
- 自动保存图片到数据库
- 传递图片URL和图片ID给上层组件

### 图片生成组件 (ImageGenerator)

```typescript
interface ImageGeneratorProps {
  onGenerated: (imageUrl: string, imageId?: string) => void;
}
```

#### 功能

- 根据文本描述生成图片
- 支持选择图片尺寸比例
- 自动保存生成的图片到数据库
- 传递图片URL和图片ID给上层组件

### 模型生成组件 (ModelingForm)

```typescript
interface ModelingFormType {
  imageSrc: string;
  imageId?: string;
  modelingModel: "Trellis" | "Tripo3D" | "Hyper3D" | "StableFast3D" | "StablePoint3D" | "OpenCV";
  modelingFormat: "glb" | "obj" | "stl";
  modelingQuality: "low" | "medium" | "high" | "extra-low";
  useHyper: boolean;
  modelingTier: "Sketch" | "Regular";
}
```

#### 功能

- 支持多种AI模型类型
- 支持控制模型输出质量
- 支持指定模型格式
- 支持图片与模型关联
- 自动保存模型到数据库

### 对比分析组件 (ComparisonForm)

```typescript
interface ComparisonResult {
  success: boolean;
  uploadedImage: {
    id: string;
    url: string;
  };
  matchedModel: {
    id: string;
    url: string;
    fileName: string;
    imageId: string;
  };
  similarityScore: number;
  commonTags: string[];
  comparisonId: string;
  message?: string;
}
```

#### 功能

- 支持上传图片进行对比分析
- 自动调用后端API进行相似度计算
- 展示对比结果，包括最相似的模型
- 显示相似度评分和共同标签
- 提供模型预览和下载功能
- 处理各种状态（加载中、错误、成功）
- 响应式布局，适应不同屏幕尺寸

### 模型记录类型 (ModelingGenerationType)

```typescript
interface ModelingGenerationType {
  taskId: string;
  modelUrl: string;
  textures: string[];
  createAt: number;
  modelingForm: ModelingFormType;
  modelId?: string;
}
```

### CameraCapture

```typescript
interface CameraCaptureProps {
  onCapture: (imageBlob: Blob) => void;
  onClose: () => void;
  isOpen: boolean;
}
```

#### 功能

- 访问并显示用户本地摄像头画面
- 允许用户拍摄照片
- 将拍摄的照片以 Blob 形式传递给父组件
- 控制摄像头的开启与关闭状态
- 处理视频加载状态，显示加载指示器
- 自动处理视频流错误，展示友好的错误信息
- 优化视频显示，解决黑屏问题
- 仅在视频准备就绪后启用拍照按钮，防止拍摄空白图片
- 支持响应式适配不同尺寸屏幕

## 文件存储

### 图片存储

图片上传后通过统一上传接口保存到服务器，并将URL和元数据保存到数据库中。系统支持以下图片格式：
- PNG
- JPEG/JPG
- WebP
- SVG

系统现已支持同时将图片保存到本地存储目录，提供以下功能：
- 自动将远程URL的图片文件保存到本地`storage/images/`目录
- 在数据库中记录本地存储路径（`local_file_path`字段）
- 即使远程链接失效也能访问图片文件
- 支持从URL和Blob两种来源保存文件

### 模型存储

#### 远程存储
3D模型在生成后将以GLB格式保存到远程服务器，并在数据库中记录以下信息：
- 文件名
- 文件URL
- 文件格式
- 文件大小
- 模型参数（JSON格式）
- 关联的图片ID

#### 本地存储
系统现已支持同时将3D模型保存到本地存储目录，提供以下功能：
- 自动将远程URL的模型文件保存到本地`storage/models/`目录
- 在数据库中记录本地存储路径（`local_file_path`字段）
- 即使远程链接失效也能访问模型文件
- 支持从URL和Blob两种来源保存文件

### 文件存储工具

```typescript
// 从URL保存文件到本地存储
function saveFileFromUrl(url: string, fileName: string): Promise<string>

// 从Blob保存文件到本地存储
function saveFileFromBlob(blob: Blob, fileName: string): Promise<string>
```
